"use strict";const e=Symbol("Placeholder"),t=t=>{let n=0;for(const s of t)s!==e&&n++;return n},n=(t,n)=>{const s=t.length,o=t.slice(),r=n.length;let i=r,c=0;for(;i&&c<s;c++)o[c]===e&&(o[c]=n[r-i],i--);for(c=s;i;c++,i--)o[c]=n[r-i];return o},s=(e,o,r)=>{const i=e.length-o.length-t(r);if(i<1)return e(...n(o,r));{const t=(...t)=>s(e,n(o,r),t);return t.$args_left=i,t}},o=e=>(...n)=>e.length>t(n)?s(e,[],n):e(...n);function r(t){return function(n,s){const o=n===e;if(1===arguments.length&&o)throw new Error("Senseless placeholder usage.");return arguments.length>1?o?(t=>function(n){return n===e?t:t(n)})((e=>t(e,s))):t(n,s):e=>t(n,e)}}function i(e){return o(e)}const c=void 0,l=1/0,u=e=>typeof e,a=e=>null===e,h={u:"U",b:"B",n:"N",s:"S",f:"F"},f=e=>{const t=u(e);return"object"===t?a(e)?"Null":e.constructor.name:h[t[0]]+t.slice(1)},d=r(((e,t)=>(t.push(e),t))),g=i(((e,t,n)=>n.reduce(e,t))),p=i(((e,t,n)=>{for(let s in n)switch(f(n[s])){case"Array":if(e>1&&"Array"===f(t[s]))switch(e){case 2:const o=t[s],r=n[s];for(const t in r)o[t]?p(e,o[t],r[t]):o[t]=r[t];break;case 3:t[s].push(...n[s])}else t[s]=n[s];break;case"Object":if("Object"===f(t[s])){p(e,t[s],n[s]);break}default:t[s]=n[s]}return t}));p(1),p(2),p(3);const m=r(((e,t)=>{const n=f(e);if(n===f(t)&&("Object"===n||"Array"==n)){if(a(e)||a(t))return e===t;if(e===t)return!0;for(const n of[e,t])for(const s in n)if(!(n===t&&s in e||n===e&&s in t&&m(e[s],t[s])))return!1;return!0}return e===t})),y=o(((e,t,n,s)=>e(s)?t(s):n(s))),w=(...t)=>(...n)=>{let s,o=!0;for(let r=E(t)-1;r>-1;r--)o?(o=!1,s=t[r](...n)):s=s===e?t[r]():t[r](s);return s},b=r(((e,t)=>t[e])),_=r(((e,t)=>{if((e=>"string"===u(e))(t))return t.includes(e);for(const n of t)if(m(n,e))return!0;return!1})),k=i(((e,t,n)=>n.slice(e,(e=>"number"==u(e))(t)?t:l))),S=b(0);k(1,l);const v=e=>a(e)||(e=>e===c)(e),E=e=>e.length,j=e=>()=>e,N=r(((e,t)=>t.split(e))),O=e=>g(((e,t)=>_(t,e)?e:d(t,e)),[],e),P=i(((e,t,n)=>({...n,[e]:t}))),q=r(((e,t)=>t[e])),A=i(((e,t,n)=>y(E,(()=>v(n)?e:w(y(v,j(e),(n=>A(e,k(1,l,t),n))),(e=>r(((t,n)=>e(n,t))))(q)(n),S)(t)),j(n),t)));A(c);const Q=/^(.*?)(8|16|32|64)(Clamped)?Array$/,$=(e,t=!1)=>{const n=f(e);switch(n){case"Null":case"String":case"Number":case"Boolean":case"Symbol":return e;case"Array":return t?[...e]:C(w($,((...e)=>e[0])),e);case"Object":if(t)return{...e};const s={};for(let t in e)s[t]=$(e[t]);return s;default:return Q.test(n)?e.constructor.from(e):e}},W=i(((e,t,n)=>g(e,$(t),n))),C=r(((e,t)=>t.map(e))),{floor:R}=Math;let z,B;const D=w((e=>W(((e,t)=>P(...t,e)),{},e)),C(((e,t)=>[e,t])),N(""));(e=>{if(!(e=>w(m(E(e)),E,O,N(""))(e))(e))throw new Error("Not all chars are unique!");z=e,B=z.length,D(z)})("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");const I=Symbol("Placeholder"),T=e=>{let t=0;for(const n of e)n!==I&&t++;return t},U=(e,t)=>{const n=e.length,s=e.slice(),o=t.length;let r=o,i=0;for(;r&&i<n;i++)s[i]===I&&(s[i]=t[o-r],r--);for(i=n;r;i++,r--)s[i]=t[o-r];return s},x=(e,t,n)=>{const s=e.length-t.length-T(n);if(s<1)return e(...U(t,n));{const o=(...s)=>x(e,U(t,n),s);return o.$args_left=s,o}},F=e=>(...t)=>e.length>T(t)?x(e,[],t):e(...t);function J(e){return function(t,n){const s=t===I,o=arguments.length;if(1===o&&s)throw new Error("Senseless placeholder usage.");return o>1?s?(e=>function(t){return t===I?e:e(t)})((t=>e(t,n))):e(t,n):n=>e(t,n)}}function L(e){return F(e)}const M=void 0,G=1/0,H=e=>typeof e,K=e=>null===e,V=e=>"number"==H(e),X={u:"U",b:"B",n:"N",s:"S",f:"F"},Y=Symbol(),Z=e=>{const t=H(e);return"object"===t?K(e)?"Null":e.constructor.name:X[t[0]]+t.slice(1)},ee=e=>e.length,te=e=>K(e)||(e=>e===M)(e),ne=J(((e,t)=>e===t)),se=J(((e,t)=>{const n=Z(e);if(ne(n,Z(t))&&(ne(n,"Object")||ne(n,"Array"))){if(K(e)||K(t))return ne(e,t);if(ne(e,t))return!0;for(const n of[e,t])for(const s in n)if(!(ne(n,t)&&s in e||ne(n,e)&&s in t&&se(e[s],t[s])))return!1;return!0}return ne(e,t)})),oe=J(((e,t)=>(t.push(e),t))),re=L(((e,t,n)=>n.reduce(e,t))),ie=F(((e,t,n,s)=>e(s)?t(s):n(s))),ce=(...e)=>(...t)=>{let n,s=!0;for(let o=ee(e)-1;o>-1;o--)s?(s=!1,n=e[o](...t)):n=n===I?e[o]():e[o](n);return n},le=J(((e,t)=>t[e])),ue=L(((e,t,n)=>n.slice(e,V(t)?t:G))),ae=le(0);ue(1,G);const he=J(((e,t)=>t.find(e))),fe=e=>()=>e,de=fe(!0),ge=fe(!1),pe=J(((e,t)=>re(((t,n)=>he((t=>e(n,t)),t)?t:oe(n,t)),[],t)));pe(se);const me=e=>{let t,n=!1;return(...s)=>n?t:(n=!0,t=e(...s))},ye=L(((e,t,n)=>ee(t)?te(n)?e:ce((s=>s in n?ye(e,ue(1,G,t),n[s]):e),ae)(t):n));ye(M),ce(ie(se(Y),ge,de),ye(Y));const we=(e,t,n)=>e.addEventListener(t,n),be=(e,t)=>setTimeout(t,e),_e=function(e){const t=this.config;this.open=!0,this.onReadyQueue.forEach((e=>e())),this.onReadyQueue.splice(0);const{id_key:n,data_key:s}=t.server;if(this.handlers.open.forEach((e=>e())),this.messages.forEach((e=>e.send())),null!==this.reconnect_timeout&&(clearInterval(this.reconnect_timeout),this.reconnect_timeout=null),t.ping){const e=setInterval((()=>{this.open&&this.send(t.ping.content),this.forcibly_closed&&clearInterval(e)}),1e3*t.ping.interval)}we(e,"close",(async()=>{this.log("close"),this.open=!1,this.onCloseQueue.forEach((e=>e())),this.onCloseQueue=[];const e=t.reconnect;if("number"!=typeof e||isNaN(e)||this.forcibly_closed)this.ws=null,this.open=null;else{const t=async()=>{this.log("reconnect"),null!==this.ws&&(this.ws.close(),this.ws=null);null!==await this.connect()&&(this.reconnect_timeout=setTimeout(t,1e3*e))};t()}this.forcibly_closed=!1})),we(e,"message",(e=>{try{const o=t.decode(e.data);if(this.handlers.message.forEach((t=>t({...e,data:o}))),o[n]){const e=this.queue[o[n]];if(e){const t=e.sent_time?Date.now()-e.sent_time:null;this.log("message",o[s],t),e.ff(o[s]),clearTimeout(e.timeout),delete this.queue[o[n]]}}}catch(t){console.error(t,`WSP: Decode error. Got: ${e.data}`)}}))},ke=function(e){if(!0===this.open)return e(null);const t=this.config,n=t.socket||t.adapter(t.url,t.protocols);if(this.ws=n,!n||n.readyState>1)return this.ws=null,this.log("error","ready() on closing or closed state! status 2."),e(2);we(n,"error",me((t=>(this.log("error","status 3."),this.handlers.error.forEach((e=>e(t))),this.ws=null,e(3))))),n.readyState?(_e.call(this,n),e(null)):we(n,"open",me((()=>(this.log("open"),_e.call(this,n),e(null)))))},Se={data_type:"json",log:()=>null,timer:!1,url:"localhost",timeout:1400,reconnect:2,lazy:!1,socket:null,adapter:(e,t)=>new WebSocket(e,t),encode:(e,t,{server:n})=>JSON.stringify({[n.id_key]:e,[n.data_key]:t}),decode:e=>JSON.parse(e),protocols:[],pipes:[],server:{id_key:"id",data_key:"data"},ping:{interval:55,content:{}}};module.exports=class{open=!1;ws=null;forcibly_closed=!1;reconnect_timeout=null;queue={};messages=[];onReadyQueue=[];onCloseQueue=[];handlers={open:[],message:[],close:[],error:[]};config={};init_flush(){this.queue={},this.messages=[]}log(e,t=null,n=null){const s=this.config;null!==n?s.log(e,n,t):s.timer?s.log(e,null,t):s.log(e,t)}async connect(){return new Promise((e=>{ke.call(this,e)}))}get socket(){return this.ws}async ready(){return new Promise((e=>{this.open?e():this.onReadyQueue.push(e)}))}on(e,t,n=de,s=!1){const o=e=>n(e)&&t(e);return s?we(this.ws,e,o):this.handlers[e].push(o)}async close(){return new Promise(((e,t)=>{null===this.ws?t("WSP: closing a non-inited socket!"):(this.open=!1,this.onCloseQueue.push((()=>{this.init_flush(),this.ws=null,this.forcibly_closed=!0,e(null)})),this.ws.close())}))}async send(e,t={}){this.log("send",e);const n=this.config,s={},o=n.server.data_key,r=n.lazy&&!this.open,i=(e=>{let t="";for(;e>0;)t=z[e%B]+t,e=R(e/B);return t||"0"})(2147483637*Math.random()|0);if("object"==typeof t.top){if(t.top[o])throw new Error("Attempting to set data key/token via send() options!");Object.assign(s,t.top)}if(n.pipes.forEach((t=>e=t(e))),!0===this.open)this.ws.send(n.encode(i,e,n));else if(!1===this.open||r)this.messages.push({send:()=>this.ws.send(n.encode(i,e,n))}),r&&this.connect();else if(null===this.open)throw new Error("Attempting to send via closed WebSocket connection!");return new Promise(((t,s)=>{this.queue[i]={ff:t,data_type:n.data_type,sent_time:n.timer?Date.now():null,timeout:be(n.timeout,(()=>{this.queue[i]&&(s({"Websocket timeout expired: ":n.timeout,"for the message ":e}),delete this.queue[i])}))}}))}constructor(e={}){this.config=(e=>{const t=Object.assign({},Se,e),n=t.url;if("/"==n[0])try{const e=location.protocol.includes("s:")?"wss":"ws";t.url=`${e}://${location.hostname}:${location.port}${n}`}catch(e){throw new Error("WSP: URL starting with / in non-browser environment!")}return t})(e),this.init_flush(),this.open=!1,this.reconnect_timeout=null,this.forcibly_closed=!1,this.config.lazy||this.connect()}};
